<!doctype html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>–ü—Ä–æ—Ñ—ñ–ª—å –ø–∞—Ü—ñ—î–Ω—Ç–∞</title>
  <link rel="stylesheet" href="assets/styles.css">

  <style>
    /* ===== Stones UI (–ø–µ—Ä–µ–Ω–µ—Å–µ–Ω–æ –∑ –≤–∞—à–æ–≥–æ index.html) ===== */
    .stones-wrap{ margin-top:10px; }
    .stones-groups{ display:flex; flex-direction:column; gap:18px; margin-bottom:14px; }

    .stone-group{
      border:1px solid rgba(255,255,255,.14);
      border-radius:14px;
      background:rgba(255,255,255,.04);
      overflow:hidden;
    }
    .group-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:16px 20px;
      cursor:pointer;
      background:rgba(255,255,255,.08);
      border-bottom:1px solid rgba(255,255,255,.10);
      transition:background .2s;
    }
    .group-header:hover{ background:rgba(255,255,255,.12); }

    .group-title{
      display:flex;
      align-items:center;
      gap:12px;
      font-size:20px;
      font-weight:800;
    }

    .group-count{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      min-width:32px;
      height:32px;
      padding:0 10px;
      border-radius:10px;
      background:rgba(255,255,255,.14);
      font-size:15px;
      font-weight:900;
    }

    .group-toggle{ font-size:24px; transition:transform .3s; user-select:none; }
    .group-toggle.collapsed{ transform:rotate(-90deg); }

    .group-content{
      display:flex;
      flex-direction:column;
      gap:12px;
      padding:16px;
      max-height:1000px;
      transition:max-height .3s ease, padding .3s ease;
      overflow:hidden;
    }
    .group-content.collapsed{ max-height:0; padding:0 16px; }

    .stone-card{
      display:flex;
      align-items:center;
      gap:18px;
      padding:18px 22px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.06);
    }

    .stone-number{
      width:48px;
      height:48px;
      border-radius:12px;
      background:linear-gradient(135deg, rgba(74,134,255,.55), rgba(60,120,255,.35));
      display:grid;
      place-items:center;
      font-size:26px;
      font-weight:900;
      flex-shrink:0;
    }

    .stone-info{
      flex:1;
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap:12px 24px;
    }

    .stone-field{ display:flex; flex-direction:column; gap:4px; }
    .stone-field-label{
      font-size:13px;
      color:rgba(255,255,255,.65);
      font-weight:600;
      text-transform:uppercase;
      letter-spacing:.5px;
    }
    .stone-field-value{ font-size:17px; font-weight:700; color:rgba(255,255,255,.92); }

    .stone-actions{ display:flex; gap:10px; flex-shrink:0; }

    .btn-icon{
      width:40px;
      height:40px;
      border-radius:10px;
      border:1px solid rgba(255,255,255,.18);
      background:rgba(255,255,255,.08);
      color:rgba(255,255,255,.92);
      display:grid;
      place-items:center;
      cursor:pointer;
      font-size:20px;
      position:relative;
    }
    .btn-icon:hover{ background:rgba(255,255,255,.14); }
    .btn-icon.danger{
      border-color:rgba(255,106,95,.35);
      background:rgba(255,106,95,.15);
    }
    .btn-icon.danger:hover{ background:rgba(255,106,95,.25); }

    .file-input{
      position:absolute;
      opacity:0;
      width:100%;
      height:100%;
      cursor:pointer;
      top:0;
      left:0;
    }

    .photo-badge{
      position:absolute;
      top:-6px;
      right:-6px;
      width:20px;
      height:20px;
      border-radius:50%;
      background:linear-gradient(135deg, #4a86ff, #3c78ff);
      color:#fff;
      font-size:11px;
      font-weight:900;
      display:grid;
      place-items:center;
      border:2px solid rgba(255,255,255,.12);
    }

    .btn-stone{
      display:inline-flex;
      align-items:center;
      gap:14px;
      padding:16px 20px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.18);
      background:linear-gradient(180deg, rgba(74,134,255,.55), rgba(60,120,255,.35));
      color:#fff;
      font-size:20px;
      font-weight:800;
      text-decoration:none;
      box-shadow:0 10px 22px rgba(0,0,0,.18);
      cursor:pointer;
    }
    .btn-stone:hover{ filter:brightness(1.05); }
    .plus{
      width:32px;
      height:32px;
      border-radius:10px;
      display:grid;
      place-items:center;
      background:rgba(255,255,255,.18);
      font-size:26px;
      line-height:0;
    }

    @media (max-width: 980px){
      .stone-info{ grid-template-columns:1fr; }
      .stone-card{ flex-direction:column; align-items:stretch; }
      .stone-actions{ justify-content:flex-end; }
    }

    /* ===== Photo Modal (FULLSCREEN PHOTO ONLY) ===== */
    .modal-overlay{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.65);
      display:none;
      align-items:stretch;
      justify-content:stretch;
      padding:0;
      z-index:9999;
    }
    .modal{
      width:100vw;
      height:100vh;
      border-radius:0;
      border:0;
      background:rgba(20,28,52,.96);
      box-shadow:none;
      display:grid;
      grid-template-rows:auto 1fr auto;
    }
    .modal-header,.modal-footer{
      background:rgba(255,255,255,.06);
      border-color:rgba(255,255,255,.12);
      padding:12px 16px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .modal-title{ font-weight:900; display:flex; gap:10px; align-items:center; }
    .pill{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding:4px 10px;
      border-radius:999px;
      font-size:12px;
      font-weight:900;
      background:rgba(255,255,255,.10);
      border:1px solid rgba(255,255,255,.14);
    }
    .modal-close{
      border:1px solid rgba(255,255,255,.18);
      background:rgba(255,255,255,.08);
      color:rgba(255,255,255,.90);
      width:44px;height:44px;border-radius:14px;
      cursor:pointer;font-size:22px;
      display:grid;place-items:center;
    }
    .modal-close:hover{ background:rgba(255,255,255,.12); }

    .modal-body{
      display:grid;
      grid-template-columns: 1fr 340px;
      gap:16px;
      padding:16px;
      overflow:hidden;
    }
    .viewer{
      min-height:0;
      height:100%;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.06);
      display:grid;
      place-items:center;
      overflow:hidden;
    }
    .viewer img{
      max-width:100%;
      max-height:100%;
      object-fit:contain;
      user-select:none;
      -webkit-user-drag:none;
    }
    .viewer-empty{ color:rgba(255,255,255,.72); font-weight:800; }

    .thumbs{
      width:100%;
      max-width:340px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.04);
      padding:10px;
      overflow:auto;
    }
    .thumb{
      display:flex;
      gap:10px;
      align-items:center;
      padding:8px;
      border-radius:12px;
      cursor:pointer;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.04);
      margin-bottom:8px;
    }
    .thumb.active{
      background:rgba(74,134,255,.16);
      border-color:rgba(74,134,255,.35);
    }
    .thumb img{ width:62px;height:48px;object-fit:cover;border-radius:10px; }
    .thumb-meta{ display:flex; flex-direction:column; gap:4px; }
    .thumb-name{ font-weight:900; font-size:13px; }
    .thumb-date{ font-size:12px; color:rgba(255,255,255,.65); }

    .modal-footer .caption{ color:rgba(255,255,255,.78); font-weight:700; }
    .modal-footer .nav{ display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end; }
    .modal-footer button{
      border:1px solid rgba(255,255,255,.18);
      background:rgba(255,255,255,.08);
      color:rgba(255,255,255,.92);
      padding:12px 14px;
      border-radius:12px;
      cursor:pointer;
      font-weight:800;
    }
    .modal-footer button:disabled{ opacity:.5; cursor:not-allowed; }
    .danger-btn{
      border-color:rgba(255,106,95,.35) !important;
      background:rgba(255,106,95,.15) !important;
    }

    @media (max-width: 980px){
      .modal-body{ grid-template-columns:1fr; }
      .thumbs{ max-width:none; max-height:260px; }
    }
  </style>
</head>
<body>
  <div class="frame">
    <div class="content">
      <div class="toolbar" style="justify-content:space-between;">
        <a class="btn" href="index.html">‚Üê –°–ø–∏—Å–æ–∫ –ø–∞—Ü—ñ—î–Ω—Ç—ñ–≤</a>
        <a class="btn" id="editBasicBtn" href="#">‚úé –†–µ–¥–∞–≥—É–≤–∞—Ç–∏ –±–∞–∑–æ–≤—ñ –¥–∞–Ω—ñ</a>
      </div>

      <h1 id="title">–ü—Ä–æ—Ñ—ñ–ª—å –ø–∞—Ü—ñ—î–Ω—Ç–∞</h1>

      <div class="card" id="basicCard">
        <div class="kv" id="basicKv"></div>
      </div>

      <h2>–î–æ–¥–∞—Ç–∫–æ–≤—ñ —Ñ–æ—Ä–º–∏</h2>
      <div class="toolbar">
        <a class="btn" id="treatmentBtn" href="#">–ü–∞—Ä–∞–º–µ—Ç—Ä–∏ –ª—ñ–∫—É–≤–∞–Ω–Ω—è</a>
        <a class="btn" id="conditionsBtn" href="#">–°—É–ø—É—Ç–Ω—ñ —Å—Ç–∞–Ω–∏</a>
      </div>

      <div class="card" id="extrasCard" style="margin-bottom:12px;">
        <div class="kv" id="extrasKv"></div>
      </div>

      <h2>–ö–∞–º–µ–Ω—ñ</h2>
      <div class="stones-wrap">
        <div class="stones-groups" id="stonesGroups"></div>

        <a href="#" class="btn-stone" id="addStoneBtn">
          <span class="plus">+</span>
          <span>–î–æ–¥–∞—Ç–∏ –∫–∞–º—ñ–Ω—å</span>
        </a>
        <div class="helper">
          –î–ª—è –∫–æ–∂–Ω–æ–≥–æ –∫–∞–º–µ–Ω—è: –æ—Ä–≥–∞–Ω/–ª–æ–∫–∞–ª—ñ–∑–∞—Ü—ñ—è/—Ä–æ–∑–º—ñ—Ä–∏/—â—ñ–ª—å–Ω—ñ—Å—Ç—å/–ø—Ä–æ–≥–Ω–æ–∑/—Å—Ç–∞—Ç—É—Å/–∑–Ω–∏–∫–Ω–µ–Ω–Ω—è/–Ω–æ—Ç–∞—Ç–∫–∏ + —Ñ–æ—Ç–æ (—Å–∫—Ä—ñ–Ω—à–æ—Ç DICOM –∑ —Ä–æ–∑–º—ñ—Ç–∫–æ—é).
        </div>
      </div>
    </div>
  </div>

  <!-- ===== Photo Modal ===== -->
  <div class="modal-overlay" id="photoModalOverlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-label="–ü–µ—Ä–µ–≥–ª—è–¥ —Ñ–æ—Ç–æ">
      <div class="modal-header">
        <div class="modal-title" id="photoModalTitle">
          –ü–µ—Ä–µ–≥–ª—è–¥ —Ñ–æ—Ç–æ <span class="pill" id="photoCountPill">0 —Ñ–æ—Ç–æ</span>
        </div>
        <button class="modal-close" type="button" onclick="closePhotoModal()" aria-label="–ó–∞–∫—Ä–∏—Ç–∏">√ó</button>
      </div>

      <div class="modal-body">
        <div class="viewer" id="photoViewer">
          <div class="viewer-empty">–ù–µ–º–∞—î —Ñ–æ—Ç–æ</div>
        </div>
        <div class="thumbs" id="photoThumbs"></div>
      </div>

      <div class="modal-footer">
        <div class="caption" id="photoCaption">‚Äî</div>
        <div class="nav">
          <button type="button" onclick="prevPhoto()" id="prevBtn">‚Üê –ü–æ–ø–µ—Ä–µ–¥–Ω—î</button>
          <button type="button" onclick="nextPhoto()" id="nextBtn">–ù–∞—Å—Ç—É–ø–Ω–µ ‚Üí</button>
          <button type="button" class="danger-btn" onclick="deleteCurrentPhoto()" id="delBtn">–í–∏–¥–∞–ª–∏—Ç–∏ —Ñ–æ—Ç–æ</button>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import {
      qs, getPatientById, loadPatientExtras,
      loadStones, saveStones,
      loadStonePhotos, saveStonePhotos,
      loadCollapsedGroups, saveCollapsedGroups
    } from './assets/storage.js';

    // ===== labels (—è–∫ —É –≤–∞—à–æ–º—É index.html) =====
    const organLabels = { RK:'–ü—Ä–∞–≤–∞ –Ω–∏—Ä–∫–∞', LK:'–õ—ñ–≤–∞ –Ω–∏—Ä–∫–∞', RU:'–ü—Ä–∞–≤–∏–π —Å–µ—á–æ–≤—ñ–¥', LU:'–õ—ñ–≤–∏–π —Å–µ—á–æ–≤—ñ–¥', BL:'–°–µ—á–æ–≤–∏–π –º—ñ—Ö—É—Ä' };
    const locationLabels = {
      upper_calyx:'–í–µ—Ä—Ö–Ω—è —á–∞—à–µ—á–∫–∞', middle_calyx:'–°–µ—Ä–µ–¥–Ω—è —á–∞—à–µ—á–∫–∞', lower_calyx:'–ù–∏–∂–Ω—è —á–∞—à–µ—á–∫–∞',
      renal_pelvis:'–ú–∏—Å–∫–∞', upj:'UPJ', ureter_proximal:'–ü—Ä–æ–∫—Å–∏–º–∞–ª—å–Ω–∞ —á–∞—Å—Ç–∏–Ω–∞', ureter_middle:'–°–µ—Ä–µ–¥–Ω—è —á–∞—Å—Ç–∏–Ω–∞',
      ureter_distal:'–î–∏—Å—Ç–∞–ª—å–Ω–∞ —á–∞—Å—Ç–∏–Ω–∞', uvj_orifice:'–í—ñ—á–∫–æ (UVJ)', bladder:'–°–µ—á–æ–≤–∏–π –º—ñ—Ö—É—Ä'
    };
    const statusLabels = { active:'–ê–∫—Ç–∏–≤–Ω–∏–π', shrinking:'–ó–º–µ–Ω—à—É—î—Ç—å—Å—è', no_response:'–ë–µ–∑ –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ', resolved:'–ó–Ω–∏–∫' };
    const prognosisLabels = { high:'–í–∏—Å–æ–∫–∞', medium:'–°–µ—Ä–µ–¥–Ω—è', low:'–ù–∏–∑—å–∫–∞' };

    // ===== patient init =====
    const patientId = qs('patient');
    if (!patientId){
      alert('–ù–µ–º–∞—î patient id —É URL.');
      window.location.href = 'patients-list.html';
    }

    const patient = getPatientById(patientId);
    if (!patient){
      alert('–ü–∞—Ü—ñ—î–Ω—Ç–∞ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ.');
      window.location.href = 'patients-list.html';
    }

    // links
    document.getElementById('editBasicBtn').href = 'create-patient.html';
    document.getElementById('treatmentBtn').href = `patient-treatment.html?patient=${encodeURIComponent(patientId)}`;
    document.getElementById('conditionsBtn').href = `patient-conditions.html?patient=${encodeURIComponent(patientId)}`;

    // header
    document.getElementById('title').textContent = `–ü—Ä–æ—Ñ—ñ–ª—å –ø–∞—Ü—ñ—î–Ω—Ç–∞: ${patient.full_name}`;

    function kvRow(k, v){
      return `<div class="k">${escapeHtml(k)}</div><div class="v">${escapeHtml(v ?? '‚Äî')}</div>`;
    }
    document.getElementById('basicKv').innerHTML = [
      kvRow('–ü–Ü–ë', patient.full_name),
      kvRow('–î–∞—Ç–∞ –Ω–∞—Ä–æ–¥–∂–µ–Ω–Ω—è', patient.date_of_birth),
      kvRow('–ú–µ–¥–∏—á–Ω–∞ –∫–∞—Ä—Ç–∫–∞', patient.medical_chart || '‚Äî'),
      kvRow('Email', patient.email),
      kvRow('–¢–µ–ª–µ—Ñ–æ–Ω', patient.phone),
      kvRow('–ó—Ä—ñ—Å—Ç', patient.height_cm ? `${patient.height_cm} —Å–º` : '‚Äî'),
      kvRow('–ß–∞—Å–æ–≤–∏–π –ø–æ—è—Å', patient.timezone),
      kvRow('–ü—Ä–æ—Ñ—ñ–ª—å', patient.profile),
    ].join('');

    // extras summary
    function renderExtras(){
      const extras = loadPatientExtras(patientId) || {};
      const cond = extras.conditions || {};
      const condList = [];
      if (cond.gout) condList.push('–ü–æ–¥–∞–≥—Ä–∞');
      if (cond.diabetes1) condList.push('–î—ñ–∞–±–µ—Ç 1 —Ç–∏–ø—É');
      if (cond.hypertension) condList.push('–ì—ñ–ø–µ—Ä—Ç–µ–Ω–∑—ñ—è');
      if (cond.custom) condList.push(cond.custom);

      const extrasKv = document.getElementById('extrasKv');
      extrasKv.innerHTML = [
        kvRow('–¢–∏–ø –ª—ñ–∫—É–≤–∞–Ω–Ω—è', extras.treatment_type || '‚Äî'),
        kvRow('–¢–∏–ø –∫–∞–º–µ–Ω—é', extras.stone_type || '‚Äî'),
        kvRow('–î–∞—Ç–∞ –ø–æ—á–∞—Ç–∫—É —Å–ø–æ—Å—Ç–µ—Ä–µ–∂–µ–Ω–Ω—è', extras.start_date || '‚Äî'),
        kvRow('–°—É–ø—É—Ç–Ω—ñ —Å—Ç–∞–Ω–∏', condList.length ? condList.join('; ') : '‚Äî'),
      ].join('');
    }
    renderExtras();

    // ===== stones state (per patient) =====
    let collapsedGroups = loadCollapsedGroups(patientId);
    let stonePhotos = loadStonePhotos(patientId);

    function deleteStone(stoneId) {
      if (!confirm('–í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ, —â–æ —Ö–æ—á–µ—Ç–µ –≤–∏–¥–∞–ª–∏—Ç–∏ —Ü–µ–π –∫–∞–º—ñ–Ω—å?')) return;
      const stones = loadStones(patientId);
      const idx = stones.findIndex(s => s.id === stoneId);
      if (idx === -1) return;
      stones.splice(idx, 1);
      saveStones(patientId, stones);

      delete stonePhotos[stoneId];
      saveStonePhotos(patientId, stonePhotos);

      renderStones();
    }

    function uploadPhotos(stoneId, files) {
      if (!files || files.length === 0) return;
      const photosArray = stonePhotos[stoneId] || [];

      Array.from(files).forEach(file => {
        if (file.type.startsWith('image/')) {
          const reader = new FileReader();
          reader.onload = (e) => {
            photosArray.push({ name:file.name, data:e.target.result, timestamp:Date.now() });
            stonePhotos[stoneId] = photosArray;
            saveStonePhotos(patientId, stonePhotos);
            renderStones();
          };
          reader.readAsDataURL(file);
        }
      });
    }

    function viewNotes(stoneId) {
      const stones = loadStones(patientId);
      const stone = stones.find(s => s.id === stoneId);
      const notes = (stone && stone.notes) ? stone.notes : '';
      alert(notes ? notes : '–ù–æ—Ç–∞—Ç–∫–∏ –≤—ñ–¥—Å—É—Ç–Ω—ñ');
    }

    function editStone(stoneId) {
      // add-stone.html –æ—á—ñ–∫—É—î return —Ç–∞ edit
      window.location.href = `add-stone.html?return=patient-profile.html%3Fpatient%3D${encodeURIComponent(patientId)}&patient=${encodeURIComponent(patientId)}&edit=${encodeURIComponent(stoneId)}`;
    }

    // ===== grouping =====
    function groupStones(stones) {
      const groups = {};
      stones.forEach((stone) => {
        let groupKey, groupTitle;
        if (stone.status === 'resolved') { groupKey='resolved'; groupTitle='–ó–∞–≤–µ—Ä—à–µ–Ω—ñ –∫–∞–º–µ–Ω—ñ (–∑–Ω–∏–∫–ª—ñ)'; }
        else { groupKey = stone.organ; groupTitle = organLabels[stone.organ] || stone.organ; }

        if (!groups[groupKey]) groups[groupKey] = { title: groupTitle, stones: [] };
        groups[groupKey].stones.push(stone);
      });
      return groups;
    }

    function toggleGroup(groupKey) {
      collapsedGroups[groupKey] = !collapsedGroups[groupKey];
      saveCollapsedGroups(patientId, collapsedGroups);

      const content = document.querySelector(`[data-group="${groupKey}"] .group-content`);
      const toggle = document.querySelector(`[data-group="${groupKey}"] .group-toggle`);

      if (collapsedGroups[groupKey]) { content.classList.add('collapsed'); toggle.classList.add('collapsed'); }
      else { content.classList.remove('collapsed'); toggle.classList.remove('collapsed'); }
    }

    // ===== render stones =====
    function renderStones() {
      const stones = loadStones(patientId);
      const container = document.getElementById('stonesGroups');
      if (stones.length === 0) { container.innerHTML = ''; return; }

      const groups = groupStones(stones);
      const groupOrder = ['RK', 'LK', 'RU', 'LU', 'BL', 'resolved'];

      container.innerHTML = groupOrder
        .filter(key => groups[key])
        .map(groupKey => {
          const group = groups[groupKey];
          const isCollapsed = !!collapsedGroups[groupKey];

          return `
            <div class="stone-group" data-group="${groupKey}">
              <div class="group-header" onclick="toggleGroup('${groupKey}')">
                <div class="group-title">
                  <span>${group.title}</span>
                  <span class="group-count">${group.stones.length}</span>
                </div>
                <div class="group-toggle ${isCollapsed ? 'collapsed' : ''}">‚ñº</div>
              </div>
              <div class="group-content ${isCollapsed ? 'collapsed' : ''}">
                ${group.stones.map((stone, idx) => `
                  <div class="stone-card">
                    <div class="stone-number">${idx + 1}</div>
                    <div class="stone-info">
                      ${groupKey !== 'resolved' ? `
                        <div class="stone-field">
                          <div class="stone-field-label">–õ–æ–∫–∞–ª—ñ–∑–∞—Ü—ñ—è</div>
                          <div class="stone-field-value">${locationLabels[stone.location] || stone.location}</div>
                        </div>
                      ` : `
                        <div class="stone-field">
                          <div class="stone-field-label">–û—Ä–≥–∞–Ω</div>
                          <div class="stone-field-value">${organLabels[stone.organ] || stone.organ}</div>
                        </div>
                        <div class="stone-field">
                          <div class="stone-field-label">–õ–æ–∫–∞–ª—ñ–∑–∞—Ü—ñ—è</div>
                          <div class="stone-field-value">${locationLabels[stone.location] || stone.location}</div>
                        </div>
                      `}
                      <div class="stone-field">
                        <div class="stone-field-label">–†–æ–∑–º—ñ—Ä</div>
                        <div class="stone-field-value">${stone.size_mm.length_max} √ó ${stone.size_mm.width_max} –º–º</div>
                      </div>
                     
                      <div class="stone-field">
                        <div class="stone-field-label">–©—ñ–ª—å–Ω—ñ—Å—Ç—å (HU)</div>
                        <div class="stone-field-value">
                           ${stone.density_hu.min} / ${stone.density_hu.mean} / ${stone.density_hu.max}
                        </div>
                      </div>


                      ${groupKey !== 'resolved' ? `
                        <div class="stone-field">
                          <div class="stone-field-label">–°—Ç–∞—Ç—É—Å</div>
                          <div class="stone-field-value">${statusLabels[stone.status] || stone.status}</div>
                        </div>
                      ` : ''}
                      <div class="stone-field">
                        <div class="stone-field-label">–ô–º–æ–≤—ñ—Ä–Ω—ñ—Å—Ç—å —Ä–æ–∑—á–∏–Ω–µ–Ω–Ω—è</div>
                        <div class="stone-field-value">${prognosisLabels[stone.prognosis] || stone.prognosis}</div>
                      </div>
                    </div>

                    <div class="stone-actions">
                      <button class="btn-icon" onclick="editStone('${stone.id}')" title="–†–µ–¥–∞–≥—É–≤–∞—Ç–∏">‚úé</button>

                      <button class="btn-icon" title="–ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —Ñ–æ—Ç–æ">
                        üì∑
                        ${(stonePhotos[stone.id]?.length || 0) > 0 ? `<span class="photo-badge">${stonePhotos[stone.id].length}</span>` : ''}
                        <input type="file" class="file-input" accept="image/*" multiple
                          onchange="uploadPhotos('${stone.id}', this.files)" />
                      </button>

                      <button class="btn-icon" onclick="openPhotoModal('${stone.id}')" title="–ü–µ—Ä–µ–≥–ª—è–Ω—É—Ç–∏ —Ñ–æ—Ç–æ">üìÇ</button>
                      <button class="btn-icon" onclick="viewNotes('${stone.id}')" title="–ù–æ—Ç–∞—Ç–∫–∏">üìã</button>
                      <button class="btn-icon danger" onclick="deleteStone('${stone.id}')" title="–í–∏–¥–∞–ª–∏—Ç–∏">üóëÔ∏è</button>
                    </div>
                  </div>
                `).join('')}
              </div>
            </div>
          `;
        })
        .join('');
    }

    // ===== add stone btn =====
    document.getElementById('addStoneBtn').addEventListener('click', (e) => {
      e.preventDefault();
      // –ø–µ—Ä–µ–¥–∞—î–º–æ patientId, —â–æ–± –∫–∞–º–µ–Ω—ñ –∑–±–µ—Ä—ñ–≥–∞–ª–∏—Å—è –ø—ñ–¥ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –ø–∞—Ü—ñ—î–Ω—Ç–∞
      window.location.href = `add-stone.html?return=patient-profile.html%3Fpatient%3D${encodeURIComponent(patientId)}&patient=${encodeURIComponent(patientId)}`;
    });

    // ===== Photo Modal Logic =====
    const overlay = document.getElementById('photoModalOverlay');
    const viewer = document.getElementById('photoViewer');
    const thumbs = document.getElementById('photoThumbs');
    const titleEl = document.getElementById('photoModalTitle');
    const countPill = document.getElementById('photoCountPill');
    const captionEl = document.getElementById('photoCaption');
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    const delBtn  = document.getElementById('delBtn');

    let modalStoneId = null;
    let modalPhotos = [];
    let modalIndex = 0;

    function fmtDate(ts){
      try{
        const d = new Date(ts);
        return d.toLocaleString('uk-UA', { year:'numeric', month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit' });
      }catch(e){ return ''; }
    }

    function openPhotoModal(stoneId){
      modalStoneId = stoneId;
      modalPhotos = (stonePhotos[stoneId] || []).slice().sort((a,b)=> (b.timestamp||0)-(a.timestamp||0));
      modalIndex = 0;

      const stones = loadStones(patientId);
      const stone = stones.find(s => s.id === stoneId);

      const organ = stone ? (organLabels[stone.organ] || stone.organ) : '‚Äî';
      const loc = stone ? (locationLabels[stone.location] || stone.location) : '‚Äî';
      titleEl.innerHTML = `–ü–µ—Ä–µ–≥–ª—è–¥ —Ñ–æ—Ç–æ <span class="pill">${organ}</span> <span class="pill">${loc}</span>`;
      countPill.textContent = `${modalPhotos.length} —Ñ–æ—Ç–æ`;

      overlay.style.display = 'flex';
      overlay.setAttribute('aria-hidden', 'false');
      document.body.style.overflow = 'hidden';

      renderPhotoModal();
    }

    function closePhotoModal(){
      overlay.style.display = 'none';
      overlay.setAttribute('aria-hidden', 'true');
      document.body.style.overflow = '';
      modalStoneId = null;
      modalPhotos = [];
      modalIndex = 0;
    }

    function renderPhotoModal(){
      viewer.innerHTML = '';
      if (!modalPhotos.length){
        viewer.innerHTML = `<div class="viewer-empty">–ù–µ–º–∞—î —Ñ–æ—Ç–æ –¥–ª—è —Ü—å–æ–≥–æ –∫–∞–º–µ–Ω—è</div>`;
        thumbs.innerHTML = '';
        captionEl.textContent = '‚Äî';
        prevBtn.disabled = true;
        nextBtn.disabled = true;
        delBtn.disabled  = true;
        return;
      }

      if (modalIndex < 0) modalIndex = 0;
      if (modalIndex >= modalPhotos.length) modalIndex = modalPhotos.length - 1;

      const p = modalPhotos[modalIndex];
      const img = document.createElement('img');
      img.src = p.data;
      img.alt = p.name || '–§–æ—Ç–æ';
      viewer.appendChild(img);

      captionEl.textContent = `${modalIndex+1}/${modalPhotos.length} ‚Äî ${p.name || '–§–æ—Ç–æ'} (${fmtDate(p.timestamp)})`;

      thumbs.innerHTML = modalPhotos.map((ph, i) => `
        <div class="thumb ${i===modalIndex ? 'active' : ''}" onclick="selectPhoto(${i})">
          <img src="${ph.data}" alt="">
          <div class="thumb-meta">
            <div class="thumb-name">${escapeHtml(ph.name || '–§–æ—Ç–æ')}</div>
            <div class="thumb-date">${escapeHtml(fmtDate(ph.timestamp))}</div>
          </div>
        </div>
      `).join('');

      prevBtn.disabled = (modalIndex === 0);
      nextBtn.disabled = (modalIndex === modalPhotos.length - 1);
      delBtn.disabled  = false;
    }

    function selectPhoto(i){ modalIndex = i; renderPhotoModal(); }
    function prevPhoto(){ if (modalIndex > 0){ modalIndex--; renderPhotoModal(); } }
    function nextPhoto(){ if (modalIndex < modalPhotos.length - 1){ modalIndex++; renderPhotoModal(); } }

    function deleteCurrentPhoto(){
      if (!modalPhotos.length) return;
      const p = modalPhotos[modalIndex];
      if (!confirm(`–í–∏–¥–∞–ª–∏—Ç–∏ —Ñ–æ—Ç–æ "${p.name || '–§–æ—Ç–æ'}"?`)) return;

      const arr = (stonePhotos[modalStoneId] || []);
      const idx = arr.findIndex(x => (x.timestamp === p.timestamp && x.data === p.data));
      if (idx !== -1) arr.splice(idx, 1);

      stonePhotos[modalStoneId] = arr;
      saveStonePhotos(patientId, stonePhotos);

      modalPhotos = (stonePhotos[modalStoneId] || []).slice().sort((a,b)=> (b.timestamp||0)-(a.timestamp||0));
      if (modalIndex >= modalPhotos.length) modalIndex = modalPhotos.length - 1;

      countPill.textContent = `${modalPhotos.length} —Ñ–æ—Ç–æ`;
      renderPhotoModal();
      renderStones();
    }

    function escapeHtml(str){
      return String(str).replace(/[&<>"']/g, (m)=>({
        '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
      }[m]));
    }

    overlay.addEventListener('click', (e)=>{ if (e.target === overlay) closePhotoModal(); });
    document.addEventListener('keydown', (e)=>{
      if (overlay.style.display !== 'flex') return;
      if (e.key === 'Escape') closePhotoModal();
      if (e.key === 'ArrowLeft') prevPhoto();
      if (e.key === 'ArrowRight') nextPhoto();
    });

    // init
    renderStones();

    // globals for inline onclick
    window.deleteStone = deleteStone;
    window.editStone = editStone;
    window.toggleGroup = toggleGroup;
    window.uploadPhotos = uploadPhotos;
    window.viewNotes = viewNotes;

    window.openPhotoModal = openPhotoModal;
    window.closePhotoModal = closePhotoModal;
    window.selectPhoto = selectPhoto;
    window.prevPhoto = prevPhoto;
    window.nextPhoto = nextPhoto;
    window.deleteCurrentPhoto = deleteCurrentPhoto;
  </script>
</body>
</html>
