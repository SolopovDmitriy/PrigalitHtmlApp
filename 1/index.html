<!-- index.html (–ì–û–¢–û–í–ò–ô –§–ê–ô–õ –∑ –ø–µ—Ä–µ–≥–ª—è–¥–æ–º —Ñ–æ—Ç–æ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º—É –≤—ñ–∫–Ω—ñ) -->
<!doctype html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>–°—Ç–≤–æ—Ä–∏—Ç–∏ –Ω–æ–≤–æ–≥–æ –ø–∞—Ü—ñ—î–Ω—Ç–∞</title>

  <style>
    :root{
      --bg1:#6f8fb9;
      --bg2:#3459b6;
      --panel:rgba(255,255,255,.06);
      --stroke:rgba(255,255,255,.14);
      --text:rgba(255,255,255,.92);
      --muted:rgba(255,255,255,.72);
      --btn:#4a86ff;
      --btn2:#3c78ff;
      --radius:18px;
      --shadow:0 30px 90px rgba(0,0,0,.25);
      --danger:#ff6a5f;
    }
    *{ box-sizing:border-box; }

    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:
        radial-gradient(1200px 600px at 20% 10%, rgba(255,255,255,.22), transparent 50%),
        linear-gradient(180deg, var(--bg1), var(--bg2));
      color:var(--text);
      min-height:100vh;
      padding:22px;
    }

    .frame{
      width:min(1500px, 100%);
      margin:0 auto;
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      border-radius:22px;
      box-shadow:var(--shadow);
      padding:18px;
    }

    .content{
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      border-radius:22px;
      padding:26px;
      max-height: 640px;
      overflow:auto;
    }

    h1{
      font-size:44px;
      font-weight:800;
      margin:0 0 22px;
      text-shadow:0 2px 14px rgba(0,0,0,.18);
    }

    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:18px 22px;
    }

    .label{
      font-size:18px;
      font-weight:700;
      margin-bottom:10px;
      display:flex;
      align-items:center;
      gap:8px;
    }
    .req{ color:var(--danger); }

    .input, .select{
      width:100%;
      border:1px solid var(--stroke);
      background:rgba(255,255,255,.08);
      color:var(--text);
      border-radius:12px;
      padding:14px 16px;
      font-size:18px;
      outline:none;
    }

    .seg{
      display:flex;
      border:1px solid var(--stroke);
      border-radius:12px;
      overflow:hidden;
      background:rgba(255,255,255,.06);
    }
    .seg button{
      flex:1;
      border:0;
      background:transparent;
      color:var(--text);
      font-size:18px;
      padding:14px;
      cursor:pointer;
    }
    .seg button.active{
      background:#fff;
      color:#0f172a;
      font-weight:800;
    }

    /* –ö–∞–º–µ–Ω—ñ */
    .stones-wrap{
      grid-column:1 / -1;
      margin-top:6px;
    }
    .stones-groups{
      display:flex;
      flex-direction:column;
      gap:18px;
      margin-bottom:14px;
    }

    .stone-group{
      border:1px solid rgba(255,255,255,.14);
      border-radius:14px;
      background:rgba(255,255,255,.04);
      overflow:hidden;
    }

    .group-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:16px 20px;
      cursor:pointer;
      background:rgba(255,255,255,.08);
      border-bottom:1px solid rgba(255,255,255,.10);
      transition:background .2s;
    }
    .group-header:hover{ background:rgba(255,255,255,.12); }

    .group-title{
      display:flex;
      align-items:center;
      gap:12px;
      font-size:20px;
      font-weight:800;
    }

    .group-count{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      min-width:32px;
      height:32px;
      padding:0 10px;
      border-radius:10px;
      background:rgba(255,255,255,.14);
      font-size:15px;
      font-weight:900;
    }

    .group-toggle{
      font-size:24px;
      transition:transform .3s;
      user-select:none;
    }
    .group-toggle.collapsed{ transform:rotate(-90deg); }

    .group-content{
      display:flex;
      flex-direction:column;
      gap:12px;
      padding:16px;
      max-height:1000px;
      transition:max-height .3s ease, padding .3s ease;
      overflow:hidden;
    }
    .group-content.collapsed{
      max-height:0;
      padding:0 16px;
    }

    .stone-card{
      display:flex;
      align-items:center;
      gap:18px;
      padding:18px 22px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.06);
    }

    .stone-number{
      width:48px;
      height:48px;
      border-radius:12px;
      background:linear-gradient(135deg, rgba(74,134,255,.55), rgba(60,120,255,.35));
      display:grid;
      place-items:center;
      font-size:26px;
      font-weight:900;
      flex-shrink:0;
    }

    .stone-info{
      flex:1;
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap:12px 24px;
    }

    .stone-field{
      display:flex;
      flex-direction:column;
      gap:4px;
    }

    .stone-field-label{
      font-size:13px;
      color:rgba(255,255,255,.65);
      font-weight:600;
      text-transform:uppercase;
      letter-spacing:.5px;
    }

    .stone-field-value{
      font-size:17px;
      font-weight:700;
      color:rgba(255,255,255,.92);
    }

    .stone-actions{
      display:flex;
      gap:10px;
      flex-shrink:0;
    }

    .btn-icon{
      width:40px;
      height:40px;
      border-radius:10px;
      border:1px solid rgba(255,255,255,.18);
      background:rgba(255,255,255,.08);
      color:rgba(255,255,255,.92);
      display:grid;
      place-items:center;
      cursor:pointer;
      font-size:20px;
      position:relative;
    }
    .btn-icon:hover{ background:rgba(255,255,255,.14); }
    .btn-icon.danger{
      border-color:rgba(255,106,95,.35);
      background:rgba(255,106,95,.15);
    }
    .btn-icon.danger:hover{ background:rgba(255,106,95,.25); }

    .file-input{
      position:absolute;
      opacity:0;
      width:100%;
      height:100%;
      cursor:pointer;
      top:0;
      left:0;
    }

    .photo-badge{
      position:absolute;
      top:-6px;
      right:-6px;
      width:20px;
      height:20px;
      border-radius:50%;
      background:linear-gradient(135deg, #4a86ff, #3c78ff);
      color:#fff;
      font-size:11px;
      font-weight:900;
      display:grid;
      place-items:center;
      border:2px solid rgba(255,255,255,.12);
    }

    .btn-stone{
      display:inline-flex;
      align-items:center;
      gap:14px;
      padding:16px 20px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.18);
      background:linear-gradient(180deg, rgba(74,134,255,.55), rgba(60,120,255,.35));
      color:#fff;
      font-size:20px;
      font-weight:800;
      text-decoration:none;
      box-shadow:0 10px 22px rgba(0,0,0,.18);
      cursor:pointer;
    }
    .btn-stone:hover{ filter:brightness(1.05); }

    .plus{
      width:32px;
      height:32px;
      border-radius:10px;
      display:grid;
      place-items:center;
      background:rgba(255,255,255,.18);
      font-size:26px;
      line-height:0;
    }

    .chips{
      display:flex;
      border:1px solid var(--stroke);
      border-radius:12px;
      overflow:hidden;
      margin-top:6px;
    }
    .chips button{
      flex:1;
      border:0;
      padding:16px;
      background:transparent;
      color:var(--text);
      font-size:18px;
      cursor:pointer;
      border-right:1px solid rgba(255,255,255,.10);
    }
    .chips button:last-child{ border-right:0; }

    .date-grid{
      grid-column:1 / -1;
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap:18px;
      margin-top:10px;
    }

    @media (max-width: 980px){
      .grid{ grid-template-columns:1fr; }
      .date-grid{ grid-template-columns:1fr; }
      .btn-stone{ width:100%; }
      .stone-info{ grid-template-columns:1fr; }
      .stone-card{ flex-direction:column; align-items:stretch; }
      .stone-actions{ justify-content:flex-end; }
    }

   
   /* ===== Photo Modal (FULLSCREEN PHOTO ONLY) ===== */
.modal-overlay{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.65);
  display:none;
  align-items:stretch;
  justify-content:stretch;
  padding:0;
  z-index:9999;
}

.modal{
  width:100vw;
  height:100vh;
  border-radius:0;
  border:0;
  background:rgba(20,28,52,.96);
  box-shadow:none;
  display:grid;
  grid-template-rows:auto 1fr auto;
}

/* header / footer ‚Äî –±–µ–∑ –∑–º—ñ–Ω –ª–æ–≥—ñ–∫–∏ */
.modal-header,
.modal-footer{
  background:rgba(255,255,255,.06);
  border-color:rgba(255,255,255,.12);
}

/* –û–°–ù–û–í–ù–ï: –¥–≤—ñ –∫–æ–ª–æ–Ω–∫–∏, –ø—Ä–∞–≤–∞ –§–Ü–ö–°–û–í–ê–ù–ê */
.modal-body{
  display:grid;
  grid-template-columns: 1fr 340px; /* üëà –ü–†–ê–í–ê –ß–ê–°–¢–ò–ù–ê –ù–ï –†–û–ó–¢–Ø–ì–£–Ñ–¢–¨–°–Ø */
  gap:16px;
  padding:16px;
  overflow:hidden;
}

/* –õ–Ü–í–ê –ß–ê–°–¢–ò–ù–ê ‚Äî –í–ï–õ–ò–ö–ï –§–û–¢–û */
.viewer{
  min-height:0;
  height:100%;
  border-radius:16px;
  border:1px solid rgba(255,255,255,.12);
  background:rgba(255,255,255,.06);
  display:grid;
  place-items:center;
  overflow:hidden;
}

.viewer img{
  max-width:100%;
  max-height:100%;
  object-fit:contain; /* üî• –∫–ª—é—á–æ–≤–µ */
  user-select:none;
  -webkit-user-drag:none;
}

/* –ü–†–ê–í–ê –ß–ê–°–¢–ò–ù–ê ‚Äî –°–ü–ò–°–û–ö –§–û–¢–û (–ù–ï fullscreen) */
.thumbs{
  width:100%;
  max-width:340px;
  border-radius:16px;
  border:1px solid rgba(255,255,255,.12);
  background:rgba(255,255,255,.04);
  padding:10px;
  overflow:auto;
}

/* –ø—Ä–µ–≤ º—é –∑–∞–ª–∏—à–∞—é—Ç—å—Å—è –∫–æ–º–ø–∞–∫—Ç–Ω–∏–º–∏ */
.thumb img{
  width:62px;
  height:48px;
  object-fit:cover;
}

/* –º–æ–±—ñ–ª—å–Ω–∞ –≤–µ—Ä—Å—ñ—è */
@media (max-width: 980px){
  .modal-body{
    grid-template-columns:1fr;
  }
  .thumbs{
    max-width:none;
    max-height:260px;
  }
}

  
  </style>
</head>

<body>
<div class="frame">
  <div class="content">
    <h1>–°—Ç–≤–æ—Ä–∏—Ç–∏ –Ω–æ–≤–æ–≥–æ –ø–∞—Ü—ñ—î–Ω—Ç–∞</h1>

    <div class="grid">
      <div class="field">
        <div class="label"><span class="req">*</span>–Ü–º'—è</div>
        <input class="input" placeholder="–ü–æ–≤–Ω–µ —ñ–º'—è">
      </div>

      <div class="field">
        <div class="label"><span class="req">*</span>Email</div>
        <input class="input" placeholder="patient@example.com">
      </div>

      <div class="field">
        <div class="label"><span class="req">*</span>–¢–µ–ª–µ—Ñ–æ–Ω</div>
        <input class="input" placeholder="+380...">
      </div>

      <div class="field"></div>

      <div class="field">
        <div class="label"><span class="req">*</span>–¢–∏–ø –ª—ñ–∫—É–≤–∞–Ω–Ω—è</div>
        <div class="seg">
          <button type="button" class="active">–õ—ñ–∫—É–≤–∞–Ω–Ω—è</button>
          <button type="button">–ü—Ä–æ—Ñ—ñ–ª–∞–∫—Ç–∏–∫–∞</button>
        </div>
      </div>

      <div class="field">
        <div class="label"><span class="req">*</span>–¢–∏–ø –∫–∞–º–µ–Ω—é</div>
        <div class="seg">
          <button type="button" class="active">–£—Ä–∞—Ç–Ω–∏–π</button>
          <button type="button">–£—Ä–∞—Ç–Ω–æ-–æ–∫—Å–∞–ª–∞—Ç–Ω–∏–π</button>
        </div>
      </div>

      <!-- –ö–∞–º–µ–Ω—ñ -->
      <div class="stones-wrap">
        <div class="label"><span class="req">*</span>–ö–∞–º–µ–Ω—ñ</div>
        <div class="stones-groups" id="stonesGroups"></div>

        <a href="#" class="btn-stone" id="addStoneBtn">
          <span class="plus">+</span>
          <span>–î–æ–¥–∞—Ç–∏ –∫–∞–º—ñ–Ω—å</span>
        </a>
      </div>

      <div class="field" style="grid-column:1 / -1;">
        <div class="chips">
          <button type="button">–ü–æ–¥–∞–≥—Ä–∞</button>
          <button type="button">–î—ñ–∞–±–µ—Ç 1 —Ç–∏–ø—É</button>
          <button type="button">–ì—ñ–ø–µ—Ä—Ç–µ–Ω–∑—ñ—è</button>
          <button type="button">–°–≤—ñ–π –≤–∞—Ä—ñ–∞–Ω—Ç</button>
        </div>
      </div>

      <!-- –î–∞—Ç–∞ -->
    <!-- –î–∞—Ç–∞ –ø–æ—á–∞—Ç–∫—É —Å–ø–æ—Å—Ç–µ—Ä–µ–∂–µ–Ω–Ω—è -->
<div class="field" style="grid-column:1 / -1;">
  <div class="label">
    <span class="req">*</span>–î–∞—Ç–∞ –ø–æ—á–∞—Ç–∫—É —Å–ø–æ—Å—Ç–µ—Ä–µ–∂–µ–Ω–Ω—è
  </div>
  <input
    type="date"
    class="input"
    id="startDate"
    name="startDate"
    required
  >
</div>



      
    </div>
  </div>
</div>

<!-- ===== Photo Modal Markup ===== -->
<div class="modal-overlay" id="photoModalOverlay" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-label="–ü–µ—Ä–µ–≥–ª—è–¥ —Ñ–æ—Ç–æ">
    <div class="modal-header">
      <div class="modal-title" id="photoModalTitle">
        –ü–µ—Ä–µ–≥–ª—è–¥ —Ñ–æ—Ç–æ
        <span class="pill" id="photoCountPill">0 —Ñ–æ—Ç–æ</span>
      </div>
      <button class="modal-close" type="button" onclick="closePhotoModal()" aria-label="–ó–∞–∫—Ä–∏—Ç–∏">√ó</button>
    </div>

    <div class="modal-body">
      <div class="viewer" id="photoViewer">
        <div class="viewer-empty">–ù–µ–º–∞—î —Ñ–æ—Ç–æ</div>
      </div>

      <div class="thumbs" id="photoThumbs"></div>
    </div>

    <div class="modal-footer">
      <div class="caption" id="photoCaption">‚Äî</div>
      <div class="nav">
        <button type="button" onclick="prevPhoto()" id="prevBtn">‚Üê –ü–æ–ø–µ—Ä–µ–¥–Ω—î</button>
        <button type="button" onclick="nextPhoto()" id="nextBtn">–ù–∞—Å—Ç—É–ø–Ω–µ ‚Üí</button>
        <button type="button" class="danger-btn" onclick="deleteCurrentPhoto()" id="delBtn">–í–∏–¥–∞–ª–∏—Ç–∏ —Ñ–æ—Ç–æ</button>
      </div>
    </div>
  </div>
</div>

<script>
  // ===== labels =====
  const organLabels = { RK:'–ü—Ä–∞–≤–∞ –Ω–∏—Ä–∫–∞', LK:'–õ—ñ–≤–∞ –Ω–∏—Ä–∫–∞', RU:'–ü—Ä–∞–≤–∏–π —Å–µ—á–æ–≤—ñ–¥', LU:'–õ—ñ–≤–∏–π —Å–µ—á–æ–≤—ñ–¥', BL:'–°–µ—á–æ–≤–∏–π –º—ñ—Ö—É—Ä' };
  const locationLabels = {
    upper_calyx:'–í–µ—Ä—Ö–Ω—è —á–∞—à–µ—á–∫–∞', middle_calyx:'–°–µ—Ä–µ–¥–Ω—è —á–∞—à–µ—á–∫–∞', lower_calyx:'–ù–∏–∂–Ω—è —á–∞—à–µ—á–∫–∞',
    renal_pelvis:'–ú–∏—Å–∫–∞', upj:'UPJ', ureter_proximal:'–ü—Ä–æ–∫—Å–∏–º–∞–ª—å–Ω–∞ —á–∞—Å—Ç–∏–Ω–∞', ureter_middle:'–°–µ—Ä–µ–¥–Ω—è —á–∞—Å—Ç–∏–Ω–∞',
    ureter_distal:'–î–∏—Å—Ç–∞–ª—å–Ω–∞ —á–∞—Å—Ç–∏–Ω–∞', uvj_orifice:'–í—ñ—á–∫–æ (UVJ)', bladder:'–°–µ—á–æ–≤–∏–π –º—ñ—Ö—É—Ä'
  };
  const statusLabels = { active:'–ê–∫—Ç–∏–≤–Ω–∏–π', shrinking:'–ó–º–µ–Ω—à—É—î—Ç—å—Å—è', no_response:'–ë–µ–∑ –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ', resolved:'–ó–Ω–∏–∫' };
  const prognosisLabels = { high:'–í–∏—Å–æ–∫–∏–π', medium:'–°–µ—Ä–µ–¥–Ω—ñ–π', low:'–ù–∏–∑—å–∫–∏–π' };

  // ===== stable id =====
  function makeStoneId(){
    if (window.crypto && crypto.randomUUID) return crypto.randomUUID();
    return 'st_' + Date.now() + '_' + Math.random().toString(16).slice(2);
  }

  // ===== state =====
  let collapsedGroups = JSON.parse(localStorage.getItem('collapsed_groups') || '{}');
  let stonePhotos = JSON.parse(localStorage.getItem('temp_stone_photos') || '{}');

  function loadStones() {
    const data = localStorage.getItem('temp_stones');
    const stones = data ? JSON.parse(data) : [];
    let changed = false;
    stones.forEach(s => { if (!s.id) { s.id = makeStoneId(); changed = true; } });
    if (changed) localStorage.setItem('temp_stones', JSON.stringify(stones));
    return stones;
  }
  function saveStones(stones) { localStorage.setItem('temp_stones', JSON.stringify(stones)); }

  function deleteStone(stoneId) {
    if (!confirm('–í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ, —â–æ —Ö–æ—á–µ—Ç–µ –≤–∏–¥–∞–ª–∏—Ç–∏ —Ü–µ–π –∫–∞–º—ñ–Ω—å?')) return;
    const stones = loadStones();
    const idx = stones.findIndex(s => s.id === stoneId);
    if (idx === -1) return;
    stones.splice(idx, 1);
    saveStones(stones);
    delete stonePhotos[stoneId];
    localStorage.setItem('temp_stone_photos', JSON.stringify(stonePhotos));
    renderStones();
  }

  function uploadPhotos(stoneId, files) {
    if (!files || files.length === 0) return;
    const photosArray = stonePhotos[stoneId] || [];

    Array.from(files).forEach(file => {
      if (file.type.startsWith('image/')) {
        const reader = new FileReader();
        reader.onload = (e) => {
          photosArray.push({ name:file.name, data:e.target.result, timestamp:Date.now() });
          stonePhotos[stoneId] = photosArray;
          localStorage.setItem('temp_stone_photos', JSON.stringify(stonePhotos));
          renderStones();
        };
        reader.readAsDataURL(file);
      }
    });
  }

  function viewNotes(stoneId) {
    const stones = loadStones();
    const stone = stones.find(s => s.id === stoneId);
    const notes = (stone && stone.notes) ? stone.notes : '';
    alert(notes ? notes : '–ù–æ—Ç–∞—Ç–∫–∏ –≤—ñ–¥—Å—É—Ç–Ω—ñ');
  }

  function editStone(stoneId) {
    window.location.href = `add-stone.html?return=index.html&edit=${encodeURIComponent(stoneId)}`;
  }

  // ===== grouping =====
  function groupStones(stones) {
    const groups = {};
    stones.forEach((stone) => {
      let groupKey, groupTitle;
      if (stone.status === 'resolved') { groupKey='resolved'; groupTitle='–ó–∞–≤–µ—Ä—à–µ–Ω—ñ –∫–∞–º–µ–Ω—ñ (–∑–Ω–∏–∫–ª—ñ)'; }
      else { groupKey = stone.organ; groupTitle = organLabels[stone.organ] || stone.organ; }

      if (!groups[groupKey]) groups[groupKey] = { title: groupTitle, stones: [] };
      groups[groupKey].stones.push(stone);
    });
    return groups;
  }

  function toggleGroup(groupKey) {
    collapsedGroups[groupKey] = !collapsedGroups[groupKey];
    localStorage.setItem('collapsed_groups', JSON.stringify(collapsedGroups));

    const content = document.querySelector(`[data-group="${groupKey}"] .group-content`);
    const toggle = document.querySelector(`[data-group="${groupKey}"] .group-toggle`);

    if (collapsedGroups[groupKey]) { content.classList.add('collapsed'); toggle.classList.add('collapsed'); }
    else { content.classList.remove('collapsed'); toggle.classList.remove('collapsed'); }
  }

  // ===== render stones =====
  function renderStones() {
    const stones = loadStones();
    const container = document.getElementById('stonesGroups');
    if (stones.length === 0) { container.innerHTML = ''; return; }

    const groups = groupStones(stones);
    const groupOrder = ['RK', 'LK', 'RU', 'LU', 'BL', 'resolved'];

    container.innerHTML = groupOrder
      .filter(key => groups[key])
      .map(groupKey => {
        const group = groups[groupKey];
        const isCollapsed = collapsedGroups[groupKey];

        return `
          <div class="stone-group" data-group="${groupKey}">
            <div class="group-header" onclick="toggleGroup('${groupKey}')">
              <div class="group-title">
                <span>${group.title}</span>
                <span class="group-count">${group.stones.length}</span>
              </div>
              <div class="group-toggle ${isCollapsed ? 'collapsed' : ''}">‚ñº</div>
            </div>
            <div class="group-content ${isCollapsed ? 'collapsed' : ''}">
              ${group.stones.map((stone, idx) => `
                <div class="stone-card">
                  <div class="stone-number">${idx + 1}</div>
                  <div class="stone-info">
                    ${groupKey !== 'resolved' ? `
                      <div class="stone-field">
                        <div class="stone-field-label">–õ–æ–∫–∞–ª—ñ–∑–∞—Ü—ñ—è</div>
                        <div class="stone-field-value">${locationLabels[stone.location] || stone.location}</div>
                      </div>
                    ` : `
                      <div class="stone-field">
                        <div class="stone-field-label">–û—Ä–≥–∞–Ω</div>
                        <div class="stone-field-value">${organLabels[stone.organ] || stone.organ}</div>
                      </div>
                      <div class="stone-field">
                        <div class="stone-field-label">–õ–æ–∫–∞–ª—ñ–∑–∞—Ü—ñ—è</div>
                        <div class="stone-field-value">${locationLabels[stone.location] || stone.location}</div>
                      </div>
                    `}
                    <div class="stone-field">
                      <div class="stone-field-label">–†–æ–∑–º—ñ—Ä</div>
                      <div class="stone-field-value">${stone.size_mm.length_max} √ó ${stone.size_mm.width_max} –º–º</div>
                    </div>
                    <div class="stone-field">
                      <div class="stone-field-label">–©—ñ–ª—å–Ω—ñ—Å—Ç—å</div>
                      <div class="stone-field-value">${stone.density_hu.min}‚Äì${stone.density_hu.max} HU</div>
                    </div>
                    ${groupKey !== 'resolved' ? `
                      <div class="stone-field">
                        <div class="stone-field-label">–°—Ç–∞—Ç—É—Å</div>
                        <div class="stone-field-value">${statusLabels[stone.status] || stone.status}</div>
                      </div>
                    ` : ''}
                    <div class="stone-field">
                      <div class="stone-field-label">–ü—Ä–æ–≥–Ω–æ–∑</div>
                      <div class="stone-field-value">${prognosisLabels[stone.prognosis] || stone.prognosis}</div>
                    </div>
                  </div>

                  <div class="stone-actions">
                    <button class="btn-icon" onclick="editStone('${stone.id}')" title="–†–µ–¥–∞–≥—É–≤–∞—Ç–∏">‚úé</button>

                    <button class="btn-icon" title="–ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —Ñ–æ—Ç–æ">
                      üì∑
                      ${(stonePhotos[stone.id]?.length || 0) > 0 ? `<span class="photo-badge">${stonePhotos[stone.id].length}</span>` : ''}
                      <input type="file" class="file-input" accept="image/*" multiple
                        onchange="uploadPhotos('${stone.id}', this.files)" />
                    </button>

                    <button class="btn-icon" onclick="openPhotoModal('${stone.id}')" title="–ü–µ—Ä–µ–≥–ª—è–Ω—É—Ç–∏ —Ñ–æ—Ç–æ">üìÇ</button>
                    <button class="btn-icon" onclick="viewNotes('${stone.id}')" title="–ù–æ—Ç–∞—Ç–∫–∏">üìã</button>
                    <button class="btn-icon danger" onclick="deleteStone('${stone.id}')" title="–í–∏–¥–∞–ª–∏—Ç–∏">üóëÔ∏è</button>
                  </div>
                </div>
              `).join('')}
            </div>
          </div>
        `;
      })
      .join('');
  }

  // ===== add stone btn =====
  document.getElementById('addStoneBtn').addEventListener('click', (e) => {
    e.preventDefault();
    window.location.href = 'add-stone.html?return=index.html';
  });

  // ===== Photo Modal Logic =====
  const overlay = document.getElementById('photoModalOverlay');
  const viewer = document.getElementById('photoViewer');
  const thumbs = document.getElementById('photoThumbs');
  const titleEl = document.getElementById('photoModalTitle');
  const countPill = document.getElementById('photoCountPill');
  const captionEl = document.getElementById('photoCaption');
  const prevBtn = document.getElementById('prevBtn');
  const nextBtn = document.getElementById('nextBtn');
  const delBtn  = document.getElementById('delBtn');

  let modalStoneId = null;
  let modalPhotos = [];
  let modalIndex = 0;

  function fmtDate(ts){
    try{
      const d = new Date(ts);
      return d.toLocaleString('uk-UA', { year:'numeric', month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit' });
    }catch(e){ return ''; }
  }

  function openPhotoModal(stoneId){
    modalStoneId = stoneId;
    modalPhotos = (stonePhotos[stoneId] || []).slice().sort((a,b)=> (b.timestamp||0)-(a.timestamp||0));
    modalIndex = 0;

    const stones = loadStones();
    const stone = stones.find(s => s.id === stoneId);

    const organ = stone ? (organLabels[stone.organ] || stone.organ) : '‚Äî';
    const loc = stone ? (locationLabels[stone.location] || stone.location) : '‚Äî';
    titleEl.innerHTML = `–ü–µ—Ä–µ–≥–ª—è–¥ —Ñ–æ—Ç–æ <span class="pill">${organ}</span> <span class="pill">${loc}</span>`;
    countPill.textContent = `${modalPhotos.length} —Ñ–æ—Ç–æ`;

    overlay.style.display = 'flex';
    overlay.setAttribute('aria-hidden', 'false');
    document.body.style.overflow = 'hidden';

    renderPhotoModal();
  }

  function closePhotoModal(){
    overlay.style.display = 'none';
    overlay.setAttribute('aria-hidden', 'true');
    document.body.style.overflow = '';
    modalStoneId = null;
    modalPhotos = [];
    modalIndex = 0;
  }

  function renderPhotoModal(){
    // viewer
    viewer.innerHTML = '';
    if (!modalPhotos.length){
      viewer.innerHTML = `<div class="viewer-empty">–ù–µ–º–∞—î —Ñ–æ—Ç–æ –¥–ª—è —Ü—å–æ–≥–æ –∫–∞–º–µ–Ω—è</div>`;
      thumbs.innerHTML = '';
      captionEl.textContent = '‚Äî';
      prevBtn.disabled = true;
      nextBtn.disabled = true;
      delBtn.disabled  = true;
      return;
    }

    if (modalIndex < 0) modalIndex = 0;
    if (modalIndex >= modalPhotos.length) modalIndex = modalPhotos.length - 1;

    const p = modalPhotos[modalIndex];
    const img = document.createElement('img');
    img.src = p.data;
    img.alt = p.name || '–§–æ—Ç–æ';
    viewer.appendChild(img);

    captionEl.textContent = `${modalIndex+1}/${modalPhotos.length} ‚Äî ${p.name || '–§–æ—Ç–æ'} (${fmtDate(p.timestamp)})`;

    // thumbs
    thumbs.innerHTML = modalPhotos.map((ph, i) => `
      <div class="thumb ${i===modalIndex ? 'active' : ''}" onclick="selectPhoto(${i})">
        <img src="${ph.data}" alt="">
        <div class="thumb-meta">
          <div class="thumb-name">${escapeHtml(ph.name || '–§–æ—Ç–æ')}</div>
          <div class="thumb-date">${escapeHtml(fmtDate(ph.timestamp))}</div>
        </div>
      </div>
    `).join('');

    prevBtn.disabled = (modalIndex === 0);
    nextBtn.disabled = (modalIndex === modalPhotos.length - 1);
    delBtn.disabled  = false;
  }

  function selectPhoto(i){
    modalIndex = i;
    renderPhotoModal();
  }

  function prevPhoto(){
    if (modalIndex > 0){ modalIndex--; renderPhotoModal(); }
  }

  function nextPhoto(){
    if (modalIndex < modalPhotos.length - 1){ modalIndex++; renderPhotoModal(); }
  }

  function deleteCurrentPhoto(){
    if (!modalPhotos.length) return;
    const p = modalPhotos[modalIndex];
    if (!confirm(`–í–∏–¥–∞–ª–∏—Ç–∏ —Ñ–æ—Ç–æ "${p.name || '–§–æ—Ç–æ'}"?`)) return;

    // –≤–∏–¥–∞–ª—è—î–º–æ –∑ stonePhotos[modalStoneId]
    const arr = (stonePhotos[modalStoneId] || []);
    const idx = arr.findIndex(x => (x.timestamp === p.timestamp && x.data === p.data));
    if (idx !== -1) arr.splice(idx, 1);

    stonePhotos[modalStoneId] = arr;
    localStorage.setItem('temp_stone_photos', JSON.stringify(stonePhotos));

    // –ø–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –º–æ–¥–∞–ª—å–Ω—ñ –¥–∞–Ω—ñ
    modalPhotos = (stonePhotos[modalStoneId] || []).slice().sort((a,b)=> (b.timestamp||0)-(a.timestamp||0));
    if (modalIndex >= modalPhotos.length) modalIndex = modalPhotos.length - 1;

    countPill.textContent = `${modalPhotos.length} —Ñ–æ—Ç–æ`;
    renderPhotoModal();
    renderStones(); // —â–æ–± –æ–Ω–æ–≤–∏–≤—Å—è –±–µ–π–¥–∂ –Ω–∞ –∫–Ω–æ–ø—Ü—ñ
  }

  function escapeHtml(str){
    return String(str).replace(/[&<>"']/g, (m)=>({
      '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
    }[m]));
  }

  // overlay click to close (—Ç—ñ–ª—å–∫–∏ —è–∫—â–æ –∫–ª—ñ–∫ –ø–æ —Ñ–æ–Ω—É)
  overlay.addEventListener('click', (e)=>{
    if (e.target === overlay) closePhotoModal();
  });

  // keyboard
  document.addEventListener('keydown', (e)=>{
    if (overlay.style.display !== 'flex') return;
    if (e.key === 'Escape') closePhotoModal();
    if (e.key === 'ArrowLeft') prevPhoto();
    if (e.key === 'ArrowRight') nextPhoto();
  });

  // ===== init =====
  renderStones();

  // –∑—Ä–æ–±–∏—Ç–∏ –≥–ª–æ–±–∞–ª—å–Ω–∏–º–∏
  window.deleteStone = deleteStone;
  window.editStone = editStone;
  window.toggleGroup = toggleGroup;
  window.uploadPhotos = uploadPhotos;
  window.viewNotes = viewNotes;

  window.openPhotoModal = openPhotoModal;
  window.closePhotoModal = closePhotoModal;
  window.selectPhoto = selectPhoto;
  window.prevPhoto = prevPhoto;
  window.nextPhoto = nextPhoto;
  window.deleteCurrentPhoto = deleteCurrentPhoto;
</script>

</body>
</html>
